<html>

    <head>
        <meta charset="utf-8">
        <title>Кровля</title>
    
        <link rel="stylesheet" href="../../css/style.css">
        <link rel="stylesheet" href="../../css/catalog.css">

        <script src="https://kit.fontawesome.com/ed646ce458.js" crossorigin="anonymous"></script>
        <script src="../../js/generate_product_page.js" type="module"></script>
        <script type="module">
            import "../../js/js_libs/xlsx.min.js";

            
            /**
             * sheet2arr(sheet) - обрабатывает данные выбранного листа из базы данных.
             * Возвращается: двумерный массив данных (таблица).
             **/
            function sheet2arr(sheet)
            {
                const result = [];
                let row;
                let row_num;
                let col_num;
                const range = XLSX.utils.decode_range(sheet['!ref']);
    
                for(row_num = range.s.r + 1; row_num <= range.e.r; row_num++) 
                {
                    row = [];
                    for(col_num = range.s.c; col_num <= range.e.c; col_num++)
                    {
                        const nextCell = sheet
                        [
                            XLSX.utils.encode_cell({ r: row_num, c: col_num })
                        ];
                        if(typeof nextCell === 'undefined') 
                        {
                            row.push(void 0);
                        } 
                        else 
                        {
                            row.push(nextCell.w);
                        }
                    }          
                    result.push(row);
                }
                return result;
            }
            
            /** 
             * product_page() - генерирует модальное окно с информацией о выбранном товаре.
             **/
            function product_card()
            {
                let div_modal = document.createElement("div");
                div_modal.className = "modal";

                document.body.append(div_modal);

                let div_modaL_window = document.createElement("div");
                div_modaL_window.className = "modaL_window";
                div_modaL_window.innerHTML = "<h1>ТОВАР</h1>"

                div_modal.append(div_modaL_window);

                let button_close = document.createElement("button");
                button_close.className = "btn_close"
                button_close.innerHTML = "x";

                div_modaL_window.append(button_close);

                let div_overlay = document.createElement("div");
                div_overlay.className = "overlay";

                div_modal.append(div_overlay);

                console.log(document);
            }
    
            function generate_product_page() 
            {
                const req = new XMLHttpRequest();
                req.open('GET', '../../catalog.xlsx', true);
                req.responseType = 'arraybuffer';
                req.send();
                req.onload = function() 
                {
                    //Обработка базы данных представленной в виде xlsx-файла.
                    const workBook = XLSX.read(req.response, {type:'array'});
                    const allSheets = Object.keys(workBook.Sheets).map((sheet) => 
                    {
                        return {
                            sheet: sheet,
                            rows: sheet2arr(workBook.Sheets[sheet])
                        };
                    });
                    const roof_sheet = allSheets[0];

                    //TODO: масштабировать; добавть обработку наличия товара;

                    //Генерирует карточки товаров по данным из базы данных.
                    for (let i = 0; i < 7; i++) 
                    {
                        let button_product = document.createElement("button");
                        button_product.className = "product";
                        button_product.onclick = product_card;
                        
                        container.append(button_product);

                        let div_image = document.createElement("div");
                        div_image.className = "image";
                        div_image.innerHTML = "<img src=\"../../" + roof_sheet.rows[i][5] + "\" alt=\"\">";

                        button_product.append(div_image);

                        let div_info = document.createElement("div");
                        div_info.className = "info";
                        div_info.innerHTML = "<h3>" + roof_sheet.rows[i][2] + "</h3>";

                        button_product.append(div_info);

                        let div_price = document.createElement("div");
                        div_price.className = "info-price";
                        
                        div_info.append(div_price);

                        let span_price = document.createElement("span");
                        span_price.className = "price";
                        span_price.innerHTML = roof_sheet.rows[i][3] + "<small> ₽/</small>шт";

                        div_price.append(span_price);

                        let button_price = document.createElement("button");
                        button_price.className = "add-to-cart";
                        button_price.innerHTML = "<i class=\"fa-solid fa-cart-shopping\"></i>";

                        div_price.append(button_price);
                    }
                }
            }
            
            generate_product_page();
        </script>
    </head>

    <body>
        <!-- <header>
            <a href="#" class="logo">АРСЕНАЛ</a>

            <nav>
                <ul>
                    <li><a href="../../index.html">Главная</a></li>
                    <li>
                        <a href="#">Каталог</a>
                        
                        <ul>
                            <li><a href="roof.html">Кровля</a></li>
                            <li><a href="#">Сухие смеси и грунтовки</a></li>
                            <li><a href="#">Изоляционные материалы</a></li>
                            <li><a href="#">Листовые материалы</a></li>
                            <li><a href="#">Дорожные покрытия</a></li>
                            <li><a href="#">Фасадные материалы</a></li>
                            <li><a href="#">Подвесные потолки</a></li>
                            <li><a href="#">Блоки для строительства</a></li>
                            <li><a href="#">Металлопрокат</a></li>
                        </ul>
                    </li>
                    <li><a href="../questions.html">Вопросы</a></li>
                    <li><a href="../contacts.html">Контакты</a></li>
                    <li><a href="#"><i class="fa-solid fa-cart-shopping"></i></a></li>
                </ul>
            </nav>
        </header> -->

        <div class="container" id="container">
        </div>
    </body>
</html>